<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="manifest.json">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#111">
  <title>Fiche Castle Night</title>
  <style>
.losange:hover
{
 color: #9a0091;
  content: "A";
}

    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Georgia', serif;
      background: url('parchment-texture.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #111;
      padding: 2rem;
      max-width: 900px;
      margin: auto;
    }
    h1, h2, h3 {
      text-align: center;
      font-family: 'Cinzel', serif;
      margin: 1rem 0;
    }
    label {
      font-weight: bold;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 0.3rem;
      margin: 0.2rem 0 1rem;
      border: 1px solid #888;
      border-radius: 4px;
      background: #fdfaf0;
      font-family: 'Georgia', serif;
    }
    select {
  width: 100%;
  padding: 0.3rem;
  margin: 0.2rem 0 1rem;
  border: 1px solid #888;
  border-radius: 4px;
  background: #fdfaf0;
  font-family: 'Georgia', serif;
  font-size: 1rem;
  color: #111;
}
    .section {
      border: 2px solid #222;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.85);
      padding: 1rem;
      margin-bottom: 2rem;
    }
    .grid-3, .grid-2 {
      display: grid;
      gap: 1rem;
    }
    .grid-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .grid-2 {
      grid-template-columns: repeat(2, 1fr);
    }
    textarea {
      width: 100%;
      height: 6rem;
      background: #fdfaf0;
      font-family: 'Georgia', serif;
      border: 1px solid #888;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    .stat-bar {
      height: 10px;
      background: #ccc;
      border-radius: 5px;
      margin-top: 5px;
      position: relative;
    }
    .stat-fill {
      height: 100%;
      background: #444;
      border-radius: 5px;
      width: 0%;
    }
    .skill-entry {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .skill-entry input[type="text"] {
      flex: 2;
      margin-right: 0.5rem;
    }
    .skill-entry input[type="number"] {
      width: 3rem;
      margin-right: 0.5rem;
    }
    .skill-bar {
      font-size: 1.2rem;
      letter-spacing: 1px;
    }
    .add-skill-button {
      background-color: #444;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
    }
    .tag-entry input[type="text"] {
      width: calc(100% - 2rem);
      margin-bottom: 0.5rem;
    }
.barre {
  font-size: 200%;
  cursor: pointer;
  font-family: monospace;
  user-select: none;
  color:black;
  
}
.carac {
  display: inline-block;
  width: 1rem;
  text-align: center;
}
@media (max-width: 768px) {
  body {
    padding: 1rem;
  }

  .grid-3 {
    grid-template-columns: 1fr !important;
  }

  .grid-2 {
    grid-template-columns: 1fr !important;
  }

  .skill-entry {
    flex-direction: column;
    align-items: stretch;
  }

  .skill-entry input[type="text"],
  .skill-entry input[type="number"] {
    width: 100%;
    margin: 0.2rem 0;
  }

  .add-skill-button {
    width: 100%;
  }

  h1, h2, h3 {
    font-size: 1.3rem;
  }

  .section {
    padding: 0.8rem;
    margin-bottom: 1.5rem;
  }
  .separator {
  border: none;
  height: 1.5rem;
  background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Ornamental_Fleuron.svg/1920px-Ornamental_Fleuron.svg.png') no-repeat center;
  background-size: 40px;
  margin: 2rem 0;
  opacity: 0.5;
}

@media (max-width: 768px) {
  .separator {
    background-size: 30px;
    margin: 1.5rem 0;
  }
}
}
.remove-button {
  background: none;
  border: none;
  color: #900;
  font-size: 1.2rem;
  margin-left: 0.5rem;
  cursor: pointer;
  font-weight: bold;
}

.remove-button:hover {
  color: #d00;
}
.tabs {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 1rem;
  gap: 0.5rem;
}

.tab-button {
  padding: 0.5rem 1rem;
  background-color: #eee;
  border: 1px solid #999;
  border-radius: 5px;
  cursor: pointer;
  font-family: 'Cinzel', serif;
  font-size: 1rem;
}

.tab-button.active {
  background-color: #d4c6a1;
  border-color: #555;
  font-weight: bold;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}
.title {
  display: flex;
  align-items: center;
  gap: 10px; /* espace entre le texte et le bouton */
}
body.garou-active {
  background-image: fondbestial.jpg;
  background-repeat: no-repeat, repeat;
  background-position: center center, center center;
  background-size: contain, cover;
  background-blend-mode: lighten;
  transition: background-image 0.5s ease;
  opacity: 1;
}
body.garou-active::before {
  content: "";
  position: fixed;
  top: 30%;
  left: 50%;
  width: 300px;
  height: 300px;
  transform: translate(-50%, -50%);
  background-image: url("griffes.png");
  background-repeat: no-repeat;
  background-size: contain;
  opacity: 0.2;
  pointer-events: none;
  z-index: 0;
  animation: heartBeat 1.5s ease-in-out infinite;
}

@keyframes heartBeat {
  0%   { transform: translate(-50%, -50%) scale(1); }
  25%  { transform: translate(-50%, -50%) scale(1.05); }
  40%  { transform: translate(-50%, -50%) scale(0.97); }
  60%  { transform: translate(-50%, -50%) scale(1.04); }
  100% { transform: translate(-50%, -50%) scale(1); }
}

#garouButton {
  background: none;
  border: 2px solid #444; /* couleur et épaisseur du contour */
  border-radius: 8px;      /* coins arrondis */
  padding: 4px;            /* espace entre l’image et le bord */
  cursor: pointer;
 display: none;
  opacity: 0;
  transform: scale(0.8);
  transition: opacity 0.3s ease, transform 0.3s ease;
}
#garouButton.visible {
  display: inline-block;
  opacity: 1;
  transform: scale(1);
}

#garouButton img {
width: 30px;
  height: 30px;
  vertical-align: middle;
  display: block;
    transition: transform 0.3s ease, opacity 0.2s ease;
}
#garouButton img.clicked {
  transform: scale(1.2);
  opacity: 0.8;
}

#garouButton:hover {
  transform: scale(1.1);
  border-color: #888; /* changement de couleur au survol */
}
#outils button {
  font-size: 1.5rem;
  padding: 0.5rem 1rem;
  border: 2px solid #555;
  background-color: #fdfaf0;
  border-radius: 8px;
  cursor: pointer;
}

#outils button:hover {
  background-color: #e2d5b9;
}
#rpc-result, #d3-result {
  transition: opacity 0.5s ease;
}

.hidden {
  opacity: 0;
}

button.shield-btn {
  font-family: "Cinzel", serif; /* ou autre police */
  font-weight: bold;
  font-size: 2.5rem;
  color: grey; /* couleur bois/métal rouillé */
  background: transparent;
  border: none;
  padding: 0;
  cursor: pointer;
  user-select: none;
  transition: color 0.3s ease, transform 0.3s ease;
}

button.shield-btn:hover {
  color: #8b6b3b; /* un peu plus clair au survol */
  transform: scale(1.1);
}

button.shield-btn:active {
  transform: scale(0.95);
}

/* Animation brise */
.brise {
  animation: briser 0.5s ease;
}

@keyframes briser {
  0% {
    transform: rotate(0deg) translate(0, 0);
    opacity: 1;
  }
  20% {
    transform: rotate(-15deg) translate(-5px, 5px);
    opacity: 0.9;
  }
  40% {
    transform: rotate(15deg) translate(5px, -5px);
    opacity: 0.8;
  }
  60% {
    transform: rotate(-10deg) translate(-3px, 3px);
    opacity: 0.9;
  }
  80% {
    transform: rotate(10deg) translate(3px, -3px);
    opacity: 1;
  }
  100% {
    transform: rotate(0deg) translate(0, 0);
    opacity: 1;
  }
}

  </style>
</head>
<body>
<h1 class="title">
  Castle Night
  <button id="garouButton">
    <img src="human_tranform.png" alt="Ajouter" onclick="toggleGarouImage()" />
  </button>
</h1>
  <div class="tabs">
  <button class="tab-button active" onclick="openTab('identite')">Identité</button>
  <button class="tab-button" onclick="openTab('stats')">Stats</button>
  <button class="tab-button" onclick="openTab('skills')">Compétences</button>
  <button class="tab-button" onclick="openTab('sante')">Santé</button>
  <button class="tab-button" onclick="openTab('outils')">Outils</button>
</div>
<div id="identite" class="tab-content active">
  <div class="section grid-3">
    <div><label>Nom</label><input type="text" id="nom"></div>
<div>
  <label>Race</label>
  <select id="race-select" onchange="updateFactionOptions()">
    <option value="">-- Choisir --</option>
    <option value="Métamorphe">Métamorphe</option>
    <option value="Fallen">Fallen</option>
    <option value="Hunter">Hunter</option>
    <option value="Dhampire">Dhampire</option>
    <option value="Mage">Mage</option>
    <option value="Phantasm">Phantasm</option>
  </select>
</div>
<div>
    <label for="dualite-select">Dualité :</label>
<select id="dualite-select" onchange="placerLosangeDepuisMenu()">
<option value="">-- Choisir --</option>
  <option value="physique">Physique</option>
  <option value="mental">Mental</option>
  <option value="social">Social</option>
</select>
</div>
    <div><label>Joueur</label><input type="text" id="joueur"></div>
    <div>
  <label>Faction</label>
  <select id="faction-select" disabled>
    <option value="">-- Choisir une race d'abord --</option>
  </select>
</div>
    <div><label>Aspect</label><input type="text" id="aspect"></div>
  </div>

<div class="section">
    <h2>Historiques</h2>
    <div class="grid-2">
      <div>
        <label>Traits</label>
        <div id="traits-container"></div>
        <button class="add-skill-button" onclick="addTag('traits-container', 'Nom du trait')">Ajouter un trait</button>
      </div>
      <div>
        <label>Scénaristique</label>
        <div id="story-container"></div>
        <button class="add-skill-button" onclick="addTag('story-container', 'Élément scénaristique')">Ajouter un élément scénaristique</button>
      </div>
    </div>
  </div>
</div>
<div id="stats" class="tab-content">
  <div class="section">
    <h2>Statistiques</h2>
    <div class="grid-3">
      <div>
        <label>Physique <span id="physique-losange" class ="losange" onclick="toggleLosange(this)">▴</span></label>
        <input type="number" id="statPhys" value="1" min="0" max="10" onchange ="saveData()">
        <div class="stat-bar"><div id="barPhys" class="stat-fill"></div></div>
      </div>
      <div>
        <label>Social<span id="social-losange" class ="losange" onclick="toggleLosange(this)">▴</span></label>
        <input type="number" id="statSoc" value="0" min="0" max="10"onchange ="saveData()">
        <div class="stat-bar"><div id="barSoc" class="stat-fill"></div></div>
      </div>
      <div>
        <label>Mental<span id="mental-losange" class ="losange" onclick="toggleLosange(this)">▴</span></label>
        <input type="number" id="statMent" value="0" min="0" max="10"onchange ="saveData()">
        <div class="stat-bar"><div id="barMent" class="stat-fill"></div></div>
      </div>
	  <hr class="separator">
      <div>
        <label>Racial</label>
        <input type="number" id="statRacial" value="1" min="0" max="20">
        <div class="stat-bar"><div id="barRacial" class="stat-fill" onchange ="saveData()"></div></div>
      </div>
      <div>
        <label>Aspect</label>
        <input type="number" id="statAspect" value="0" min="0" max="20">
        <div class="stat-bar"><div id="barAspect" class="stat-fill" onchange ="saveData()" ></div></div>
      </div>
      <div>
        <label>Divinité</label>
        <input type="number" id="statDiv" value="0" min="0" max="20">
        <div class="stat-bar"><div id="barDiv" class="stat-fill" onchange ="saveData()"></div></div>
      </div>
    </div>
  </div>
  </div>
<div id="skills" class="tab-content">
  <div class="section">
    <h2>Compétences</h2>
    <div id="skills-container">
      
    </div>
    <button class="add-skill-button" onclick="addSkill()">Ajouter une compétence</button>
  </div>

  <div class="section">
    <h2>Pouvoirs</h2>
    <div class="grid-3">
      <div>
        <label>Racial</label>
        <div id="racial-container"></div>
        <button class="add-skill-button" onclick="addPower('racial-container')">Ajouter un pouvoir racial</button>
      </div>
      <div>
        <label>Aspect</label>
        <div id="aspect-container"></div>
        <button class="add-skill-button" onclick="addPower('aspect-container')">Ajouter un pouvoir d'aspect</button>
      </div>
      <div>
        <label>Autre</label>
        <div id="autre-container"></div>
        <button class="add-skill-button" onclick="addPower('autre-container')">Ajouter un autre pouvoir</button>
      </div>
    </div>
  </div>
</div>
<div id="sante" class="tab-content">
  <div class="section">
    <h2>Santé</h2>
    <div class="grid-3">
      <div>
  <label>Vitalité </label>
  <div id="vitalite" class="barre"></div>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
  
</div>
<div>
  <label>Égo</label>
  <div id="ego" class="barre"></div>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
</div>
<div>
  <label>Focus</label>
  <div id="focus" class="barre"></div>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
  <button class="shield-btn" onclick="toggleShield(this)">⛉</button>
</div>

</div>
    </div>
	
	<div class="section">
    <h2>Pouvoir </h2>
    <div class="grid-3">
  <div>
  <label>Essence </label>
  <div id="essence" class="barre"></div>
</div>
  <label>Divinité</label>
  <div id="divinite" class="barre"></div>
</div>
</div>
    </div>
  </div>

<div id="outils" class="tab-content">
  <div class="section">
    <h2>Roche Papier Ciseaux</h2>
    <div class="grid-3">
      <button onclick="playRPC('🪨')">🪨 Roche</button>
      <button onclick="playRPC('📄')">📄 Papier</button>
      <button onclick="playRPC('✂️')">✂️ Ciseaux</button>
    </div>
    <p id="rpc-result" style="text-align:center; margin-top:1rem; font-weight:bold;"></p>
  </div>

  <div class="section">
    <h2>Lancer de dé (d3)</h2>
    <div style="text-align:center;">
      <button onclick="rollD3()">🎲 Lancer</button>
      <p id="d3-result" style="font-size:2rem; margin-top:1rem;"></p>
    </div>
  </div>
</div>

  <script>

//Fonction pour les choix initiaux de haut de page 
function toggleShield(button) {
  // toggle symbole
  if (button.textContent === '⛊') {
    button.textContent = '⛉';
  } else {
    button.textContent = '⛊';
  }

  // ajoute l'animation
  button.classList.add('brise');

  // enlève la classe après animation pour pouvoir rejouer
  button.addEventListener('animationend', () => {
    button.classList.remove('brise');
  }, { once: true });
}

function openTab(id) {
  // cacher tous les contenus
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });

  // désactiver tous les boutons
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });

  // activer le bon contenu et le bon bouton
  document.getElementById(id).classList.add('active');
  event.currentTarget.classList.add('active');
}

const factionOptions = {
    "Métamorphe": ["Rage d'Eden", "Gardien d'Azure", "Main-Rouge", "Architecte", "Oracle", "Mycosite"],
    "Fallen": ["Hérault", "Veilleur", "Sentinelle", "Précurseur", "Passeur", "Invocateur"],
    "Hunter": ["Valkyrie", "Enfant Divin", "Chevalier du Dragon", "Chasseur de Démon", "Vigile", "Réprouvé"],
    "Dhampire": ["Seigneur de Sang", "Mortifère", "Thalyseth", "Pestiféré", "Compte", "Scuro"],
    "Mage": ["Nécromancien", "Biomancien", "Technomancien", "Vorticien", "Exalté", "Cultiste"],
    "Phantasm": ["Aurore", "Zalam", "Génésis", "Élysium", "Mistral", "Concordia"]
  };

  function updateFactionOptions() {
    const race = document.getElementById("race-select").value;
    const factionSelect = document.getElementById("faction-select");
	const zoneLoupGarou = document.getElementById("metamorphebtn")

    factionSelect.innerHTML = ""; // Reset options

    if (!factionOptions[race]) {
      factionSelect.disabled = true;
      const option = new Option("-- Choisir une race d'abord --", "");
      factionSelect.appendChild(option);
      return;
    }
	  if (race === "Métamorphe") {
  garouButton.classList.add("visible");
} else {
  garouButton.classList.remove("visible");
}

    factionSelect.disabled = false;
    const placeholder = new Option("-- Choisir --", "");
    factionSelect.appendChild(placeholder);

    factionOptions[race].forEach(faction => {
      const option = new Option(faction, faction);
      factionSelect.appendChild(option);
    });
  }

function toggleGarouImage() {
  const button = document.getElementById("garouButton");
  const img = button.querySelector("img");
  const currentSrc = img.getAttribute("src");

  const imageNormale = "human_tranform.png";
  const imageTransformee = "loup_tranform.png";

  const statPhysInput = document.getElementById("statPhys");

  if (currentSrc === imageNormale) {
    img.setAttribute("src", imageTransformee);
    document.body.classList.add("garou-active");

    // Bonus +5 Physique
    const baseValue = parseInt(statPhysInput.value) || 0;
    statPhysInput.dataset.base = baseValue; // on sauvegarde l’original
    statPhysInput.value = baseValue + 5;

  } else {
    img.setAttribute("src", imageNormale);
    document.body.classList.remove("garou-active");

    // Retirer le bonus
    const original = parseInt(statPhysInput.dataset.base) || statPhysInput.value;
    statPhysInput.value = original;

    delete statPhysInput.dataset.base;
  }

  // Mise à jour des barres
  updateAuto?.();
  updateBarres?.();

  // Effet visuel rapide
  img.classList.add("clicked");
  setTimeout(() => {
    img.classList.remove("clicked");
  }, 200);
}


//----------------------------------
   function updateAuto() {
  const physique = parseInt(document.getElementById('statPhys').value || 0);
  const social = parseInt(document.getElementById('statSoc').value || 0);
  const mental = parseInt(document.getElementById('statMent').value || 0);
  const racial = parseInt(document.getElementById('statRacial').value || 0);
  const aspect = parseInt(document.getElementById('statAspect').value || 0);
  const divinite = parseInt(document.getElementById('statDiv').value || 0);
const essence = aspect + racial;
 // document.getElementById('essence').value = racial + aspect;

  updateStatBar("barPhys", physique, 10);
  updateStatBar("barSoc", social, 10);
  updateStatBar("barMent", mental, 10);
  updateStatBar("barRacial", racial, 20);
  updateStatBar("barAspect", aspect, 20);
  updateStatBar("barDiv", divinite, 20);
}

function updateStatBar(id, value, maxBase, maxLimit = 20) {
  const bar = document.getElementById(id);

  // Ne pas dépasser la limite
  if (value > maxLimit) value = maxLimit;

  let percent = 0;
  let color = "#444";
  let text = "";

  if (value <= maxBase) {
    percent = (value / maxBase) * 100;
    color = "#444";
  } else if (value < maxLimit) {
    percent = ((value - maxBase) / (maxLimit - maxBase)) * 100;
    color = "gold";
  } else {
    percent = 100;
    color = "rebeccapurple";
    text = "MAX";
  }

  // Applique la largeur, la couleur et le texte
  bar.style.width = percent + "%";
  bar.style.backgroundColor = color;
  bar.textContent = text;
  bar.style.color = "#fff";        // texte blanc pour le contraste
  bar.style.fontWeight = "bold";
  bar.style.textAlign = "center";
  bar.style.lineHeight = "10px";   // aligne verticalement le texte
  bar.style.fontSize = "0.75rem";
}

// --- Gestion des compétences (déjà existante) ---
function generateSkillBar(level) {
  level = parseInt(level) || 1;
  return '■'.repeat(level) + '¤'.repeat(10 - level);
}


function updateSkillBar(input) {
  const value = parseInt(input.value || 1);
  const span = input.parentElement.querySelector('.skill-bar');
  span.textContent = '■'.repeat(value) + '¤'.repeat(10 - value);
}

function addSkill(name = '', level = 1) {
  const container = document.getElementById('skills-container');
  const div = document.createElement('div');
  div.className = 'skill-entry';

  const bar = generateSkillBar(level);

  div.innerHTML = `
    <input type="text" placeholder="Nom de la compétence" value="${name}" onblur="saveData()">
    <input type="number" min="1" max="10" value="${level}" onchange="updateSkillBar(this); saveData()">
    <span class="skill-bar">${bar}</span>
    <button type="button" class="remove-button" onclick="this.parentElement.remove(); saveData()">✖</button>
  `;
  container.appendChild(div);
}
function generateSkillBar(level) {
  level = parseInt(level) || 1;
  return '■'.repeat(level) + '¤'.repeat(10 - level);
}

function addPower(containerId, name = '', level = 1) {
 const container = document.getElementById(containerId);
  const div = document.createElement('div');
  div.className = 'skill-entry';

  const bar = generateSkillBar(level); // tu peux modifier cette fonction selon ton style

  div.innerHTML = `
    <input type="text" placeholder="Nom du pouvoir" value="${name}" onblur="saveData()">
    <input type="number" min="1" max="10" value="${level}" onchange="updateSkillBar(this); saveData()">
    <span class="skill-bar">${bar}</span>
    <button type="button" class="remove-button" onclick="this.parentElement.remove(); saveData()">✖</button>
  `;

  container.appendChild(div)
}

function addTag(containerId, placeholderText) {
  const container = document.getElementById(containerId);
  const div = document.createElement('div');
  div.className = 'tag-entry';
  div.innerHTML = '<input type="text" placeholder="' + placeholderText + '">';
  container.appendChild(div);
  saveData();
}
function placerLosangeDepuisMenu() {
  const choix = document.getElementById("dualite-select").value;
  majLosanges(choix);
}

function clicLosange(champ) {
  const el = document.getElementById(champ + "-losange");
  
  if (el.textContent === "▴") {
    majLosanges(champ);
    document.getElementById("dualite-select").value = champ; // met à jour le menu
  } else {
    // Si déjà en ◆, on remet à ▴ et désélectionne dans le menu
    el.textContent = "▴";
    document.getElementById("dualite-select").value = "";
  }
}

function majLosanges(champActif) {
  ["physique", "mental", "social"].forEach(champ => {
    const el = document.getElementById(champ + "-losange");
    el.textContent = champ === champActif ? "◆" : "▴";
  });
}


// -- Sauvegarde du visuel
function saveData() {
  const data = {};

  // Tous les inputs texte et number
  document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
    data[input.id || input.placeholder] = input.value;
  });

  // Tous les selects
  document.querySelectorAll('select').forEach(select => {
    data[select.id] = select.value;
  });
  
    const racialEntries = [];
  document.querySelectorAll('#racial-container .skill-entry').forEach(entry => {
    const name = entry.querySelector('input[type="text"]')?.value || '';
    const level = entry.querySelector('input[type="number"]')?.value || '1';
    racialEntries.push({ name, level });
  });

  data['racialPowers'] = racialEntries;
  const skillEntries = [];
  document.querySelectorAll('#skills-container .skill-entry').forEach(entry => {
    const name = entry.querySelector('input[type="text"]')?.value || '';
    const level = entry.querySelector('input[type="number"]')?.value || '1';
    skillEntries.push({ name, level });
  });
  data['skills'] = skillEntries;
  const aspectEntries = [];
  document.querySelectorAll('#aspect-container .skill-entry').forEach(entry => {
    const name = entry.querySelector('input[type="text"]')?.value || '';
    const level = entry.querySelector('input[type="number"]')?.value || '1';
    aspectEntries.push({ name, level });
  });
  data['aspectPowers'] = aspectEntries;

  const autreEntries = [];
  document.querySelectorAll('#autre-container .skill-entry').forEach(entry => {
    const name = entry.querySelector('input[type="text"]')?.value || '';
    const level = entry.querySelector('input[type="number"]')?.value || '1';
    autreEntries.push({ name, level });
  });
  data['autrePowers'] = autreEntries;
  const traits = [];
  document.querySelectorAll('#traits-container input[type="text"]').forEach(input => {
    traits.push(input.value);
  });
  data['traits'] = traits;

  const story = [];
  document.querySelectorAll('#story-container input[type="text"]').forEach(input => {
    story.push(input.value);
  });
  data['story'] = story;




  localStorage.setItem('castleNightData', JSON.stringify(data));
}
function loadData() {
  let saved;
  try {
    saved = JSON.parse(localStorage.getItem("castleNightData"));
  } catch (e) {
    console.warn("Erreur de chargement des données", e);
    return;
  }
  if (!saved) return;

  document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
    const key = input.id || input.placeholder;
    if (saved[key] !== undefined) input.value = saved[key];
  });

  document.querySelectorAll('select').forEach(select => {
    if (saved[select.id] !== undefined) select.value = saved[select.id];
  });
  const racialContainer = document.getElementById('racial-container');
  racialContainer.innerHTML = ''; // Vide avant de recréer

  if (Array.isArray(saved.racialPowers)) {
  const aspectContainer = document.getElementById('aspect-container');
  aspectContainer.innerHTML = '';
  if (Array.isArray(saved.aspectPowers)) {
    saved.aspectPowers.forEach(power => {
      addPower('aspect-container', power.name, power.level);
    });
  }

  const autreContainer = document.getElementById('autre-container');
  autreContainer.innerHTML = '';
  if (Array.isArray(saved.autrePowers)) {
    saved.autrePowers.forEach(power => {
      addPower('autre-container', power.name, power.level);
    });
  }

    saved.racialPowers.forEach(power => {
      addPower('racial-container', power.name, power.level);
    });
  }

  
  const skillsContainer = document.getElementById('skills-container');
  skillsContainer.innerHTML = '';
  if (Array.isArray(saved.skills)) {
    saved.skills.forEach(skill => {
      addSkill(skill.name, skill.level);
    });
  }

  // Remise à jour visuelle
  updateAuto();
  updateBarres();
  
  const traitsContainer = document.getElementById('traits-container');
  traitsContainer.innerHTML = '';
  if (Array.isArray(saved.traits)) {
    saved.traits.forEach(value => {
      const div = document.createElement('div');
      div.className = 'tag-entry';
      div.innerHTML = '<input type="text" value="' + value + '">';
      traitsContainer.appendChild(div);
    });
  }

  const storyContainer = document.getElementById('story-container');
  storyContainer.innerHTML = '';
  if (Array.isArray(saved.story)) {
    saved.story.forEach(value => {
      const div = document.createElement('div');
      div.className = 'tag-entry';
      div.innerHTML = '<input type="text" value="' + value + '">';
      storyContainer.appendChild(div);
    });
  }

  updateFactionOptions();
}
// --- Nouveau : Affichage interactif Vitalité, Égo, Focus en blocs ■⬚▩¤ ---

const maxBar = 15;

const symbols = {
  plein: "◼",   // utilisé
  vide: "⬚",    // perdu
  bonus: "▩",   // bonus
  possible: "⛶" // futur possible
};

// fonction pour afficher la barre interactive
function renderBar(containerId, base, current) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  for (let i = 0; i < maxBar; i++) {
    const span = document.createElement("span");
    span.className = "carac";
    if (i < Math.min(current, base)) span.textContent = symbols.plein;
    else if (i < base) span.textContent = symbols.vide;
    else if (i < current) span.textContent = symbols.bonus;
    else span.textContent = symbols.possible;

    span.dataset.index = i;

    // interaction clic pour changer la valeur actuelle (current)
    span.addEventListener("click", () => {
      current = i + 1;
      renderBar(containerId, base, current);
      // Ici tu pourrais aussi mettre à jour d’autres variables ou inputs
    });

    container.appendChild(span);
  }
}

function renderBarEssence(containerId, base, current) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  for (let i = 0; i < maxBar*2; i++) {
    const span = document.createElement("span");
    span.className = "carac";
    if (i < Math.min(current, base)) span.textContent = symbols.plein;
    else if (i < base) span.textContent = symbols.vide;
    else if (i < current) span.textContent = symbols.bonus;
    else span.textContent = symbols.possible;

    span.dataset.index = i;

    // interaction clic pour changer la valeur actuelle (current)
    span.addEventListener("click", () => {
      current = i + 1;
      renderBarEssence(containerId, base, current);
      // Ici tu pourrais aussi mettre à jour d’autres variables ou inputs
    });

    container.appendChild(span);
  }
}

// fonction qui récupère les stats physiques, sociales, mentales et met à jour les barres
function updateBarres() {
  const physique = parseInt(document.getElementById('statPhys').value) || 0;
  const social = parseInt(document.getElementById('statSoc').value) || 0;
  const mental = parseInt(document.getElementById('statMent').value) || 0;
  const racial = parseInt(document.getElementById('statRacial').value || 0);
  const aspect = parseInt(document.getElementById('statAspect').value || 0);
  const divinite = parseInt(document.getElementById('statDiv').value || 0);
const essence = aspect + racial;

  // ici base et current = stat * 2 (car max 20), tu peux ajuster
  renderBar('vitalite', physique, physique);
  renderBar('ego', social, social);
  renderBar('focus', mental, mental);
  renderBar('divinite', divinite, divinite);
  renderBarEssence('essence', essence, essence);
}

function playRPC(joueur) {
  const options = ['🪨', '📄', '✂️'];
  const ordi = options[Math.floor(Math.random() * 3)];

  let resultat = "";
  if (joueur === ordi) {
    resultat = "Égalité !";
  } else if (
    (joueur === '🪨' && ordi === '✂️') ||
    (joueur === '📄' && ordi === '🪨') ||
    (joueur === '✂️' && ordi === '📄')
  ) {
    resultat = "Tu gagnes !";
  } else {
    resultat = "L’ordinateur gagne !";
  }

  const resEl = document.getElementById('rpc-result');
  resEl.textContent = `Tu : ${joueur} — Ordi : ${ordi} → ${resultat}`;
  resEl.classList.remove('hidden');

  // ⏱️ Ajout d’un fondu après 5 secondes
  setTimeout(() => {
    resEl.classList.add('hidden');
    setTimeout(() => {
      resEl.textContent = '';
    }, 500); // attendre fin de transition
  }, 3000);
}

function rollD3() {
  const result = Math.ceil(Math.random() * 3);
  const resEl = document.getElementById('d3-result');
  resEl.textContent = `🎲 Résultat : ${result}`;
  resEl.classList.remove('hidden');

  setTimeout(() => {
    resEl.classList.add('hidden');
    setTimeout(() => {
      resEl.textContent = '';
    }, 500);
  }, 3000);
}


// --- Initialisation des écouteurs et affichage ---

// mise à jour automatique de toutes les barres classiques + barres blocs
document.querySelectorAll('#statPhys, #statSoc, #statMent, #statRacial, #statAspect, #statDiv').forEach(input => {
  input.addEventListener('input', () => {
    updateAuto();
    updateBarres();
  });
});

document.querySelectorAll('input, select').forEach(input => {
  input.addEventListener('input', saveData);
});
// au chargement de la page
window.onload = () => {
loadData();
//---Est fait dans plus haut 
 // updateAuto();
 // updateBarres();
};

  </script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('Service worker enregistré', reg))
      .catch(err => console.error('Échec enregistrement SW', err));
  }

function resetData() {
  if (confirm("Es-tu sûr de vouloir réinitialiser toutes les données ?")) {
    localStorage.removeItem('castleNightData');
    location.reload();
  }
}

</script>

<button onclick="resetData()">Réinitialiser la fiche</button>
</body>
</html>
